version: '2.4'

services:
  sut:
    build: ./helios-integration-tests
    environment:
      DOCKER_HOST: 'unix:///var/run/docker.sock'
    volumes:
      - dind:/var/run
    depends_on:
      docker:
        condition: service_healthy
      helios-api:
        condition: service_started

  helios-api:
    build: ./
    image: helios
    command: socat TCP-LISTEN:80,reuseaddr,fork UNIX-CONNECT:/tmp/run/helios.sock
    depends_on:
      helios:
        condition: service_healthy
    volumes:
      - runtime:/tmp/run
    healthcheck:
      test: ['CMD', 'wget', '-O', '-', '-q', 'http://127.0.0.1/v3/ping']

  # Override default configurations
  helios:
    # Set-up required variables
    environment:
      DOCKER_HOST: 'unix:///var/run/docker.sock'
      BALENA_DEVICE_UUID: 'test-uuid'
      BALENA_SUPERVISOR_PORT: 48484
    volumes:
      - dind:/var/run
    depends_on:
      docker:
        condition: service_healthy

  docker:
    image: docker:dind
    privileged: true
    volumes:
      - dind:/var/run
    healthcheck:
      test: ['CMD', 'docker', 'ps']
      interval: 10s
      retries: 5
      timeout: 5s

volumes:
  dind:
    driver_opts:
      # Use tmpfs to avoid files remaining between runs
      type: tmpfs
      device: tmpfs
  runtime:
    driver_opts:
      type: tmpfs
      o: ''
      device: tmpfs
